% Setup microtype for pdfLaTex
\usepackage[final,tracking=true,expansion=true]{microtype}

\usepackage[sb]{libertine} % or \usepackage[sb]{libertinus}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usepackage[scaled=0.81]{beramono}
\usepackage[lcgreekalpha]{libertinust1math} % slanted integrals, by default
\usepackage{amsthm} % libertinust1math loads amsmath

\usepackage[utf8]{inputenc}
\usepackage[svgnames,table]{xcolor}

\captionnamefont{\sffamily\small\bfseries}
\captionstyle{\sffamily\small}

\setlength{\parskip}{0.5em}

% Page layout
\setlrmarginsandblock{2.83cm}{2.83cm}{*}
\setheaderspaces{*}{0.75cm}{*}
\setheadfoot{\baselineskip}{1.25cm}
%\setulmarginsandblock{4.4cm}{4.5cm}{*}
\setulmarginsandblock{3.4cm}{3.5cm}{*}
\setmarginnotes{0.5cm}{2cm}{0em}
\checkandfixthelayout

%\setsubsecheadstyle{\itshape\raggedright}
\setsubsecheadstyle{\itshape\large\raggedright}
\setsecnumdepth{subsection}
\settocdepth{subsection}

\newcommand{\parahead}[1]{\itshape{{#1}.}\hspace{0.5em}}
\setparaindent{0em}
\setbeforeparaskip{\parskip}
\setafterparaskip{0em}
\setparaheadstyle{\parahead}

\newcommand{\subsubhead}[1]{\bfseries{{#1}.}\hspace{0.5em}}
\setsubsubsecindent{0em}
\setbeforesubsubsecskip{1em}
\setaftersubsubsecskip{0em}
\setsubsubsecheadstyle{\subsubhead}

% Header and footer setup
\nouppercaseheads
\makeatletter
\makepagestyle{headings}
\makepsmarks{headings}{%
	\createmark{chapter}{left}{shownumber}{\@chapapp\ }{. \ }
	\createmark{section}{right}{shownumber}{}{. \ }
	\createplainmark{toc}{both}{\contentsname}
	\createplainmark{lof}{both}{\listfigurename}
	\createplainmark{lot}{both}{\listtablename}
	\createplainmark{bib}{both}{\bibname}
	\createplainmark{index}{both}{\indexname}
	\createplainmark{glossary}{both}{\glossaryname}
}

%\newcommand{\draftmark}{\tiny\texttt{\color{gray} DRAFT (\today)}}
\newcommand{\draftmark}{}

\makeatother
\makeevenhead{headings}{\small\sffamily\leftmark}{}{}
\makeoddhead{headings}{}{}{\small\sffamily\rightmark}
\makeevenfoot{headings}{\draftmark}{\small\sffamily\thepage}{}
\makeoddfoot{headings}{}{\small\sffamily\thepage}{\draftmark}
\pagestyle{headings}

\makeevenfoot{plain}{}{\small\sffamily\thepage}{}
\makeoddfoot{plain}{}{\small\sffamily\thepage}{}
\copypagestyle{chapter}{plain}

\makeatletter
\renewcommand{\chapterheadstart}{\vspace*{\beforechapskip}}
\renewcommand{\printchaptername}{\chapnamefont \@chapapp}
\renewcommand{\chapternamenum}{\space}
\renewcommand{\printchapternum}{\chapnumfont \thechapter}
\renewcommand{\afterchapternum}{\par\nobreak\vskip \midchapskip}
\renewcommand{\printchapternonum}{}
\renewcommand{\printchaptertitle}[1]{\chaptitlefont #1}
\renewcommand{\afterchaptertitle}{\par\nobreak\vskip \afterchapskip}
\renewcommand{\chapnamefont}{\sffamily\huge}
\renewcommand{\chapnumfont}{\sffamily\huge}
\renewcommand{\chaptitlefont}{\sffamily\huge\bfseries}
\setlength{\beforechapskip}{0pt}
\setlength{\midchapskip}{10pt}
\setlength{\afterchapskip}{20pt}
\makeatother

\renewcommand{\contentsname}{Table of Contents}

% See https://stackoverflow.com/a/46767059
\makeatletter
\newenvironment{OpeningQuote}{\begingroup\small\sffamily\raggedleft\begin{minipage}{0.9\textwidth}}{\end{minipage}\\[30pt]\endgroup\def\if@endpe{\@doendpe\let\par\@@par\iffalse}}
\makeatother
\newcommand{\OpeningQuoteSource}[2]{\par\vspace{0.5em}\raggedleft--- \textsc{#1}\\\textit{#2}}

\definecolor{shadecolor}{gray}{0.9}

\newenvironment{FloatingBox}[1]{
	\begin{figure}[b!]
	\begin{shaded}
	\small%
	\sffamily%
	\textbf{#1}\\[0.25cm]
}{
	\end{shaded}
	\end{figure}
}

\newenvironment{PriorPublication}{\begin{FloatingBox}{Material in this chapter from prior publications}}{\end{FloatingBox}}

\newenvironment{Contributions}{\begin{FloatingBox}{Contributions in this chapter}}{\end{FloatingBox}}

\newenvironment{Notation}{\begin{FloatingBox}{Notation}}{\end{FloatingBox}}

% Tango color palette
\definecolor{butter1}{HTML}{FCE94F}
\definecolor{butter2}{HTML}{EDD400}
\definecolor{butter3}{HTML}{C4A000}
\definecolor{orange1}{HTML}{FCAF3E}
\definecolor{orange2}{HTML}{F57900}
\definecolor{orange3}{HTML}{CE5C00}
\definecolor{chocolate1}{HTML}{E9B96E}
\definecolor{chocolate2}{HTML}{C17D11}
\definecolor{chocolate3}{HTML}{8F5902}
\definecolor{chameleon1}{HTML}{8AE234}
\definecolor{chameleon2}{HTML}{73D216}
\definecolor{chameleon3}{HTML}{4E9A06}
\definecolor{skyblue1}{HTML}{729FCF}
\definecolor{skyblue2}{HTML}{3465A4}
\definecolor{skyblue3}{HTML}{204A87}
\definecolor{plum1}{HTML}{AD7FA8}
\definecolor{plum2}{HTML}{75507B}
\definecolor{plum3}{HTML}{5C3566}
\definecolor{scarletred1}{HTML}{EF2929}
\definecolor{scarletred2}{HTML}{CC0000}
\definecolor{scarletred3}{HTML}{A40000}
\definecolor{aluminium1}{HTML}{EEEEEC}
\definecolor{aluminium2}{HTML}{D3D7CF}
\definecolor{aluminium3}{HTML}{BABDB6}
\definecolor{aluminium4}{HTML}{888A85}
\definecolor{aluminium5}{HTML}{555753}
\definecolor{aluminium6}{HTML}{2E3436}